<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronoStar - Stellar Age Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://aladin.cds.unistra.fr/AladinLite/api/v3/3.4.4/aladin.min.css" />
    <script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/3.4.4/aladin.js"></script>    
    <script type="text/javascript" src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --text-primary: #f0f4f8;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-cyan: #22d3ee;
            --accent-purple: #a78bfa;
            --accent-orange: #fb923c;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --border-color: #374151;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Starfield background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 50px 160px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.4), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1.5px 1.5px at 160px 120px, rgba(34,211,238,0.9), transparent),
                radial-gradient(1px 1px at 200px 50px, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 250px 180px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 300px 90px, rgba(255,255,255,0.4), transparent),
                radial-gradient(1.5px 1.5px at 350px 140px, rgba(167,139,250,0.8), transparent);
            background-size: 400px 200px;
            pointer-events: none;
            z-index: -1;
            opacity: 0.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 300;
        }

        .search-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .input-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-width: 380px;
        }

        .input-field label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-field input, .input-field select {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .input-field input:focus, .input-field select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.15);
        }

        .input-field input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            padding: 0.875rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .status-bar {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            display: none;
        }

        .status-bar.visible {
            display: block;
        }

        .status-bar .status-text {
            color: var(--accent-cyan);
        }

        .status-bar.error .status-text {
            color: var(--error);
        }

        .status-bar.success .status-text {
            color: var(--success);
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1000px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-title .icon {
            width: 18px;
            height: 18px;
            opacity: 0.8;
        }

        .panel-body {
            padding: 0.75rem;
        }

        .target-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.5rem;
        }

        .info-item {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .info-item .label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.15rem;
        }

        .info-item .value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .info-item .value.highlight {
            color: var(--accent-cyan);
        }

        .plot-container {
            width: 100%;
            height: 500px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .data-table-wrapper {
            max-height: 400px;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .data-table td {
            padding: 0.625rem 1rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary);
        }

        .data-table .target-row {
            background: rgba(34, 211, 238, 0.1);
        }

        .data-table .target-row:hover td {
            background: rgba(34, 211, 238, 0.15);
        }

        .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .full-width-panel {
            grid-column: 1 / -1;
        }

        .download-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .li-panel .li-values {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .li-item {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            text-align: center;
        }

        .li-item .li-value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-orange);
        }

        .li-item .li-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .rotation-results {
            margin-top: 1rem;
        }

        .rotation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .rotation-item .period {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.1rem;
            color: var(--accent-green);
        }

        .rotation-item .source {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .no-data {
            color: var(--text-muted);
            font-style: italic;
            padding: 1rem;
            text-align: center;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .progress-step .check {
            color: var(--success);
        }

        .progress-step .pending {
            color: var(--text-muted);
        }

        .progress-step .active {
            color: var(--accent-cyan);
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
            margin-top: 3rem;
        }

        footer a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .advanced-toggle {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .advanced-toggle:hover {
            color: var(--text-primary);
        }

        .advanced-options {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .advanced-options.visible {
            display: block;
        }

        .small-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .small-inputs .input-field {
            min-width: auto;
        }

        #aladin-lite-div {
            width: 100%;
            height: 100%;
            height: 350px;
            min-height: 350px;
            border-radius: 8px;
            overflow: hidden;
        }

        .external-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .external-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .external-link:hover {
            background: var(--border-color);
            border-color: var(--accent-cyan);
        }

        .external-link svg {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }

        .aladin-fov-info {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .aladin-fov-info .fov-value {
            color: var(--accent-cyan);
            font-family: 'IBM Plex Mono', monospace;
        }

        .youth-indicator-values {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .youth-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .youth-item .value {
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .youth-item .value.li-color { color: var(--accent-orange); }
        .youth-item .value.prot-color { color: var(--accent-green); }
        .youth-item .value.rhk-color { color: var(--accent-purple); }
        .youth-item .value.lx-color { color: var(--accent-cyan); }

        .youth-item .source {
            font-size: 0.7rem;
            color: var(--text-muted);
            max-width: 130px;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .youth-item a.source {
            color: var(--accent-cyan);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .youth-item a.source:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }

        .youth-item .error {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .youth-item .catalog-id {
            font-size: 0.65rem;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Walking emoji loader */
        .walking-loader {
            position: relative;
            height: 28px;
            margin-bottom: 0.25rem;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .walking-loader.active {
            opacity: 1;
        }
        
        .walking-emoji {
            position: absolute;
            font-size: 1.4rem;
            top: 50%;
            transform: translateY(-50%);
            animation: flyAcross 25s linear infinite;
        }
        
        .walking-emoji::after {
            content: 'Â· Â· âœ¦';
            position: absolute;
            right: 100%;
            bottom: -2px;
            margin-right: 2px;
            font-size: 0.7rem;
            opacity: 0.5;
            animation: trailFade 25s linear infinite;
            white-space: nowrap;
            letter-spacing: 3px;
            color: var(--accent-cyan);
        }
        
        @keyframes flyAcross {
            0% { left: -8%; transform: translateY(-50%) scaleX(1); }
            48% { left: 100%; transform: translateY(-50%) scaleX(1); }
            50% { left: 100%; transform: translateY(-50%) scaleX(-1); }
            98% { left: -8%; transform: translateY(-50%) scaleX(-1); }
            100% { left: -8%; transform: translateY(-50%) scaleX(1); }
        }
        
        @keyframes trailFade {
            0%, 48% { opacity: 0.4; }
            49%, 51% { opacity: 0; }
            52%, 98% { opacity: 0.4; }
            99%, 100% { opacity: 0; }
        }

        @media (max-width: 900px) {
            .panel-body > div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 1100px) {
            div[style*="display: flex"][style*="align-items: flex-start"] {
                flex-direction: column !important;
            }
            div[style*="display: flex"][style*="align-items: flex-start"] > .panel {
                width: 100% !important;
                flex: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ChronoStar</h1>
            <p class="subtitle">Stellar age analysis via youth indicators, kinematics & CMD position | Comoving search based on <a href="https://github.com/adamkraus/Comove" target="_blank" style="color: var(--accent-cyan);">FriendFinder</a></p>
            <p style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Made for members of the <a href="https://msoaresfurtado.com" target="_blank" style="color: var(--accent-purple);">Soares-Furtado Research Group</a> | University of Wisconsin-Madison</p>
        </header>

        <section class="search-section">
            <div class="walking-loader" id="walking-loader">
                <span class="walking-emoji">ðŸš€</span>
            </div>
            <div class="input-group">
                <div class="input-field">
                    <label for="target-id">Target (Gaia DR3 ID or SIMBAD Name)</label>
                    <input type="text" id="target-id" placeholder="e.g., 2007420940415412352, HD 98800, TIC 12345678" />
                </div>
                <button class="btn btn-primary" id="search-btn" onclick="runSearch()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Search
                </button>
            </div>

            <div class="advanced-toggle" onclick="toggleAdvanced()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                Advanced Options
            </div>

            <div class="advanced-options" id="advanced-options">
                <div class="small-inputs">
                    <div class="input-field">
                        <label for="velocity-limit">Velocity Limit (km/s)</label>
                        <input type="number" id="velocity-limit" value="5.0" step="0.5" />
                    </div>
                    <div class="input-field">
                        <label for="search-radius">Search Radius (pc)</label>
                        <input type="number" id="search-radius" value="25" step="5" />
                    </div>
                    <div class="input-field">
                        <label for="rv-cut">RV Cut (km/s)</label>
                        <input type="number" id="rv-cut" value="5.0" step="0.5" />
                    </div>
                </div>
            </div>

            <div class="status-bar" id="status-bar">
                <span class="status-text" id="status-text"></span>
                <div class="progress-steps" id="progress-steps"></div>
            </div>
        </section>

        <section class="results-section" id="results-section">
            <!-- Target Info and Sky View -->
            <div class="results-grid">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            Target Star
                        </span>
                    </div>
                    <div class="panel-body">
                        <div class="target-info" id="target-info"></div>
                        <div class="external-links" id="external-links"></div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            Sky View
                        </span>
                    </div>
                    <div class="panel-body">
                        <div id="aladin-lite-div"></div>
                        <div class="aladin-fov-info" id="aladin-fov-info">
                            Field of view: <span class="fov-value" id="fov-value">--</span> (search radius)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Youth Indicators + CMD Side by Side -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-start;">
                <!-- Youth Indicators Panel -->
                <div class="panel" style="flex: 1; min-width: 0;">
                    <div class="panel-header">
                        <span class="panel-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M2 12h20"></path>
                            </svg>
                            Youth Indicators
                        </span>
                    </div>
                    <div class="panel-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-orange); font-size: 0.85rem;">EW(Li) - Lithium</h4>
                                <div class="youth-indicator-values" id="li-values">
                                    <div class="no-data">Searching...</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-green); font-size: 0.85rem;">P<sub>rot</sub> - Rotation</h4>
                                <div class="youth-indicator-values" id="rotation-results">
                                    <div class="no-data">Searching...</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-purple); font-size: 0.85rem;">log(R'<sub>HK</sub>) - Activity</h4>
                                <div class="youth-indicator-values" id="rhk-results">
                                    <div class="no-data">Searching...</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-cyan); font-size: 0.85rem;">log(L<sub>X</sub>) - X-ray</h4>
                                <div class="youth-indicator-values" id="lx-results">
                                    <div class="no-data">Searching...</div>
                                </div>
                            </div>
                        </div>
                        <!-- Exoplanet alert placeholder -->
                        <div id="exoplanet-alert" style="margin-top: 0.75rem;"></div>
                    </div>
                </div>

                <!-- CMD Plot -->
                <div class="panel" style="flex: 0 0 auto; width: 420px;">
                    <div class="panel-header">
                        <span class="panel-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"></path>
                                <circle cx="9" cy="9" r="2"></circle>
                                <circle cx="19" cy="5" r="2"></circle>
                                <circle cx="14" cy="14" r="2"></circle>
                            </svg>
                            CMD
                        </span>
                        <div class="download-buttons">
                            <button class="btn btn-secondary" onclick="downloadPlot()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                PNG
                            </button>
                        </div>
                    </div>
                    <div class="panel-body" style="padding: 0.5rem;">
                        <div class="plot-container" id="cmd-plot" style="max-width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Gyrochronology Plot -->
            <div class="panel full-width-panel" id="gyro-panel" style="margin-bottom: 1rem; display: none;">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Gyrochronology: P<sub>rot</sub> vs T<sub>eff</sub>
                    </span>
                    <div class="download-buttons">
                        <button class="btn btn-secondary" onclick="downloadGyroPlot()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="panel-body" style="padding: 0.5rem;">
                    <div class="plot-container" id="gyro-plot" style="max-width: 800px; height: 450px; margin: 0 auto;"></div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="panel full-width-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                            <path d="M3 9h18M9 21V9"></path>
                        </svg>
                        Comoving Candidates
                        <span class="badge badge-info" id="candidate-count">0 stars</span>
                    </span>
                    <button class="btn btn-secondary" onclick="downloadCSV()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download CSV
                    </button>
                </div>
                <div class="panel-body">
                    <div class="data-table-wrapper">
                        <table class="data-table" id="results-table">
                            <thead>
                                <tr>
                                    <th>Index</th>
                                    <th>Gaia DR3 ID</th>
                                    <th>RA</th>
                                    <th>Dec</th>
                                    <th>G mag</th>
                                    <th>Bp-Rp</th>
                                    <th>V<sub>off</sub> (km/s)</th>
                                    <th>Sep (Â°)</th>
                                    <th>Sep 3D (pc)</th>
                                    <th>RV<sub>pred</sub></th>
                                    <th>RV<sub>obs</sub></th>
                                    <th>SpT</th>
                                    <th>RUWE</th>
                                    <th>P<sub>rot</sub> (d)</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <footer>
            <p><strong>ChronoStar</strong> | Made for the <a href="https://msoaresfurtado.com" target="_blank">Soares-Furtado Research Group</a>, UW-Madison</p>
            <p style="margin-top: 0.5rem;">Comoving search via <a href="https://github.com/adamkraus/Comove" target="_blank">FriendFinder</a> by Adam Kraus | Please cite: <a href="https://ui.adsabs.harvard.edu/abs/2021AJ....161..171T" target="_blank">Tofflemire et al. (2021)</a></p>
            <p style="margin-top: 0.5rem; color: var(--text-muted);">Data from <a href="https://vizier.cds.unistra.fr/viz-bin/VizieR-3?-source=I/355/gaiadr3" target="_blank">Gaia DR3</a> via VizieR, <a href="https://simbad.cds.unistra.fr/" target="_blank">SIMBAD</a>, and <a href="https://vizier.cds.unistra.fr/" target="_blank">VizieR catalogs</a> | All queries run client-side</p>
        </footer>
    </div>

    <script>
        // Global state
        let searchResults = [];
        let targetData = null;
        let rotationPeriods = {};

        // Reference data for spectral types (Bp-Rp to SpT mapping)
        const sptMapping = [
            { bprp: -0.037, spt: 'A0' },
            { bprp: 0.377, spt: 'F0' },
            { bprp: 0.782, spt: 'G0' },
            { bprp: 0.980, spt: 'K0' },
            { bprp: 1.84, spt: 'M0' },
            { bprp: 2.50, spt: 'M3' },
            { bprp: 3.36, spt: 'M5' },
            { bprp: 4.75, spt: 'M7' }
        ];

        // Isochrone data (simplified versions)
        const isochrones = {
            mamajek: [
                [-0.5, -1.5], [0.0, 1.5], [0.5, 3.0], [0.8, 4.0], [1.0, 4.5],
                [1.5, 6.0], [2.0, 8.0], [2.5, 9.5], [3.0, 11.0], [3.5, 12.5], [4.0, 14.0]
            ],
            pleiades: [
                [-0.5, -1.0], [0.0, 2.0], [0.5, 3.5], [0.8, 4.5], [1.0, 5.0],
                [1.5, 6.5], [2.0, 8.5], [2.5, 10.0], [3.0, 11.5], [3.5, 13.0], [4.0, 14.5]
            ]
        };

        function toggleAdvanced() {
            const options = document.getElementById('advanced-options');
            options.classList.toggle('visible');
        }

        function setStatus(message, type = 'info') {
            const statusBar = document.getElementById('status-bar');
            const statusText = document.getElementById('status-text');
            statusBar.classList.add('visible');
            statusBar.classList.remove('error', 'success');
            if (type === 'error') statusBar.classList.add('error');
            if (type === 'success') statusBar.classList.add('success');
            statusText.innerHTML = message;
        }

        function updateProgress(steps) {
            const container = document.getElementById('progress-steps');
            container.innerHTML = steps.map(s => `
                <div class="progress-step">
                    <span class="${s.status}">${s.status === 'check' ? 'âœ“' : s.status === 'active' ? 'â—‰' : 'â—‹'}</span>
                    ${s.text}
                </div>
            `).join('');
        }

        async function queryGaia(query) {
            // Use CDS VizieR TAP - same service that works for SIMBAD
            const url = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';
            
            // VizieR Gaia DR3 uses different column names than ESA
            // Map ESA names to VizieR names
            const colMapping = {
                'source_id': 'Source',
                'ra': 'RA_ICRS',
                'dec': 'DE_ICRS',
                'parallax': 'Plx',
                'parallax_error': 'e_Plx',
                'pmra': 'pmRA',
                'pmdec': 'pmDE',
                'radial_velocity': 'RV',
                'radial_velocity_error': 'e_RV',
                'phot_g_mean_mag': 'Gmag',
                'phot_bp_mean_mag': 'BPmag',
                'phot_rp_mean_mag': 'RPmag',
                'bp_rp': '"BP-RP"',
                'ruwe': 'RUWE',
                'teff_gspphot': 'Teff',
                'logg_gspphot': 'logg'
            };
            
            // Transform table names for VizieR
            let vizierQuery = query
                .replace(/gaiadr3\.gaia_source/gi, '"I/355/gaiadr3"')
                .replace(/gaiadr3\.astrophysical_parameters/gi, '"I/355/paramp"');
            
            // Replace column names (case insensitive, whole word)
            for (const [esa, viz] of Object.entries(colMapping)) {
                const regex = new RegExp(`\\b${esa}\\b`, 'gi');
                vizierQuery = vizierQuery.replace(regex, viz);
            }
            
            // Handle source_id comparisons - VizieR needs the ID as a string comparison
            // Match patterns like "Source = 12345" and convert to "Source = '12345'"
            vizierQuery = vizierQuery.replace(/Source\s*=\s*(\d+)/gi, "Source = '$1'");
            
            console.log('Gaia query via VizieR:', vizierQuery);
            
            const params = new URLSearchParams({
                REQUEST: 'doQuery',
                LANG: 'ADQL',
                FORMAT: 'json',
                QUERY: vizierQuery
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('VizieR Gaia query error:', response.status, errorText);
                    throw new Error(`Gaia query failed: ${errorText.slice(0, 200)}`);
                }
                
                const data = await response.json();
                console.log('VizieR response:', data.data?.length || 0, 'rows');
                
                // Map VizieR column names back to ESA names in metadata
                if (data.metadata) {
                    const reverseMapping = {};
                    for (const [esa, viz] of Object.entries(colMapping)) {
                        reverseMapping[viz.replace(/"/g, '')] = esa;
                    }
                    data.metadata = data.metadata.map(m => ({
                        ...m,
                        name: reverseMapping[m.name] || m.name.toLowerCase()
                    }));
                }
                
                return data;
            } catch (e) {
                console.error('Gaia query error:', e);
                throw e;
            }
        }

        async function resolveSimbad(identifier) {
            // Query SIMBAD TAP service to resolve identifier and get Gaia DR3 source_id + coordinates
            const url = 'https://simbad.cds.unistra.fr/simbad/sim-tap/sync';
            
            // First, get the object's oidref
            const query = `SELECT oidref, id FROM ident WHERE id = '${identifier.replace(/'/g, "''")}'`;
            
            const params = new URLSearchParams({
                REQUEST: 'doQuery',
                LANG: 'ADQL',
                FORMAT: 'json',
                QUERY: query
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                if (!response.ok) return null;
                const data = await response.json();
                
                if (!data.data || data.data.length === 0) return null;
                
                const oidref = data.data[0][0];
                
                // Get Gaia DR3 identifier
                const idQuery = `SELECT id FROM ident WHERE oidref = ${oidref} AND id LIKE 'Gaia DR3%'`;
                const idParams = new URLSearchParams({
                    REQUEST: 'doQuery',
                    LANG: 'ADQL',
                    FORMAT: 'json',
                    QUERY: idQuery
                });

                const idResponse = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: idParams
                });

                let gaiaId = null;
                if (idResponse.ok) {
                    const idData = await idResponse.json();
                    if (idData.data && idData.data.length > 0) {
                        const gaiaIdStr = idData.data[0][0];
                        const match = gaiaIdStr.match(/Gaia DR3\s+(\d+)/);
                        if (match) {
                            gaiaId = match[1];
                        }
                    }
                }
                
                // Also get coordinates from basic table
                const coordQuery = `SELECT ra, dec FROM basic WHERE oid = ${oidref}`;
                const coordParams = new URLSearchParams({
                    REQUEST: 'doQuery',
                    LANG: 'ADQL',
                    FORMAT: 'json',
                    QUERY: coordQuery
                });

                let ra = null, dec = null;
                const coordResponse = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: coordParams
                });

                if (coordResponse.ok) {
                    const coordData = await coordResponse.json();
                    if (coordData.data && coordData.data.length > 0) {
                        ra = coordData.data[0][0];
                        dec = coordData.data[0][1];
                    }
                }
                
                if (gaiaId) {
                    return { gaiaId, ra, dec };
                }
                
                return null;
            } catch (e) {
                console.warn('SIMBAD query failed:', e);
                return null;
            }
        }

        async function queryVizierYouthIndicators(ra, dec) {
            // Query Vizier catalogs for youth indicators: EW(Li), Prot, log(R'HK), Lx
            const results = {
                ewli: [],      // Lithium equivalent width
                prot: [],      // Rotation period
                rhk: [],       // Chromospheric activity log(R'HK)
                lx: []         // X-ray luminosity
            };

            const radius = 10 / 3600; // 10 arcsec in degrees (increased from 5)

            // Helper function to query a Vizier catalog using Simple Cone Search
            async function queryVizierCatalog(catalog, label) {
                // Use VizieR's conesearch service - most reliable for positional queries
                const radiusDeg = radius;
                
                // VizieR conesearch URL
                const url = `https://vizier.cds.unistra.fr/viz-bin/conesearch/${catalog}?RA=${ra}&DEC=${dec}&SR=${radiusDeg}&VERB=3`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log(`âœ— ${label}: HTTP ${response.status}`);
                        return null;
                    }
                    
                    const text = await response.text();
                    
                    // Parse VOTable XML response
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');
                    
                    // Get field names
                    const fields = xml.querySelectorAll('FIELD');
                    const metadata = Array.from(fields).map(f => ({ name: f.getAttribute('name') || f.getAttribute('ID') }));
                    
                    // Get data rows
                    const trs = xml.querySelectorAll('TABLEDATA TR');
                    if (trs.length === 0) {
                        console.log(`âœ— ${label}: No match found at position`);
                        return null;
                    }
                    
                    const rows = Array.from(trs).map(tr => {
                        const tds = tr.querySelectorAll('TD');
                        return Array.from(tds).map(td => {
                            const val = td.textContent.trim();
                            const num = parseFloat(val);
                            return isNaN(num) ? val : num;
                        });
                    });
                    
                    console.log(`âœ“ ${label}: Found ${rows.length} row(s), columns:`, metadata.map(m => m.name));
                    return { metadata, rows, label };
                    
                } catch (e) {
                    console.log(`âœ— ${label}: ${e.message}`);
                    return null;
                }
            }

            // Helper to find column value by name patterns
            function findColumnValue(metadata, row, patterns) {
                for (const pattern of patterns) {
                    const regex = new RegExp(pattern, 'i');
                    const colIdx = metadata.findIndex(m => regex.test(m.name));
                    if (colIdx >= 0 && row[colIdx] != null) {
                        const val = parseFloat(row[colIdx]);
                        if (!isNaN(val)) {
                            // Look for error column
                            const errPatterns = patterns.map(p => `e_?${p}|${p}_?err|E_?${p}`);
                            let errVal = null;
                            for (const ep of errPatterns) {
                                const errRegex = new RegExp(ep, 'i');
                                const errIdx = metadata.findIndex(m => errRegex.test(m.name));
                                if (errIdx >= 0 && row[errIdx] != null) {
                                    errVal = parseFloat(row[errIdx]);
                                    if (isNaN(errVal)) errVal = null;
                                    break;
                                }
                            }
                            return { value: val, error: errVal, colName: metadata[colIdx].name };
                        }
                    }
                }
                return null;
            }
            
            // Helper to find catalog ID (TIC, KIC, HD, etc.)
            function findCatalogId(metadata, row) {
                // Common ID column patterns in priority order
                const idPatterns = [
                    { pattern: /^TIC$/i, prefix: 'TIC ' },
                    { pattern: /^KIC$/i, prefix: 'KIC ' },
                    { pattern: /^EPIC$/i, prefix: 'EPIC ' },
                    { pattern: /^KOI$/i, prefix: 'KOI ' },
                    { pattern: /^HD$/i, prefix: 'HD ' },
                    { pattern: /^HIP$/i, prefix: 'HIP ' },
                    { pattern: /^TYC\d?$/i, prefix: 'TYC ' },
                    { pattern: /^GJ$/i, prefix: 'GJ ' },
                    { pattern: /^COUP$/i, prefix: 'COUP ' },
                    { pattern: /^2MASS$/i, prefix: '2MASS ' },
                    { pattern: /^WISE$/i, prefix: 'WISE ' },
                    { pattern: /^Gaia$/i, prefix: 'Gaia DR3 ' },
                    { pattern: /^Source$/i, prefix: 'Gaia DR3 ' },
                    { pattern: /^Name$/i, prefix: '' },
                    { pattern: /^ID$/i, prefix: '' },
                    { pattern: /^Star$/i, prefix: '' },
                    { pattern: /^Seq$/i, prefix: '' },
                ];
                
                for (const { pattern, prefix } of idPatterns) {
                    const colIdx = metadata.findIndex(m => pattern.test(m.name));
                    if (colIdx >= 0 && row[colIdx] != null && row[colIdx] !== '') {
                        const val = row[colIdx];
                        // Format the ID nicely
                        return prefix + String(val).trim();
                    }
                }
                return null;
            }

            // Define catalogs to search - grouped by type
            // Format: { catalog, label, type: 'li'|'prot'|'rhk'|'lx' }
            const catalogs = [
                // === Lithium EW and A(Li) catalogs ===
                { catalog: 'J/A+A/664/A78/gaia3', label: 'GALAH DR3', type: 'li' },
                { catalog: 'J/A+A/616/A10/tablea1', label: 'Gaia-ESO DR3', type: 'li' },
                { catalog: 'J/ApJ/756/24/table2', label: 'Ramirez+2012', type: 'li' },
                { catalog: 'J/A+A/576/A69/table2', label: 'Delgado Mena+2015', type: 'li' },
                { catalog: 'J/A+A/624/A78/table1', label: 'Aguilera-Gomez+2018', type: 'li' },
                { catalog: 'J/A+A/630/A104/table1', label: 'Bensby+2018', type: 'li' },
                { catalog: 'J/A+A/657/A53/tablea1', label: 'Randich+2022 (OC)', type: 'li' },
                { catalog: 'J/A+A/649/A6/tableb1', label: 'Gilmore+2022', type: 'li' },
                { catalog: 'J/A+A/612/A99/table1', label: 'Franciosini+2018', type: 'li' },
                { catalog: 'J/A+A/600/A119/table1', label: 'Bouvier+2018', type: 'li' },
                
                // === Rotation period catalogs ===
                { catalog: 'J/ApJS/250/20/table1', label: 'Canto Martins+2020', type: 'prot' },
                { catalog: 'J/ApJS/211/24/table1', label: 'McQuillan+2014', type: 'prot' },
                { catalog: 'J/ApJS/244/21/table2', label: 'Santos+2019', type: 'prot' },
                { catalog: 'J/A+A/635/A43/tableb1', label: 'Reinhold+2020', type: 'prot' },
                { catalog: 'J/ApJ/913/70/table1', label: 'Gordon+2021', type: 'prot' },
                { catalog: 'J/ApJS/271/51/table1', label: 'Claytor+2024', type: 'prot' },
                { catalog: 'J/A+A/560/A4/table1', label: 'Reinhold+2013', type: 'prot' },
                { catalog: 'J/A+A/583/A65/table2', label: 'Lehtinen+2016', type: 'prot' },
                { catalog: 'J/ApJ/879/49/table1', label: 'Curtis+2019', type: 'prot' },
                { catalog: 'J/AJ/158/77/table1', label: 'Douglas+2019', type: 'prot' },
                { catalog: 'J/A+A/616/A16/table2', label: 'Lanzafame+2018', type: 'prot' },
                { catalog: 'J/ApJ/823/16/table2', label: 'Rebull+2016', type: 'prot' },
                { catalog: 'J/AJ/164/137/table3', label: 'Boyle+2022', type: 'prot' },
                { catalog: 'J/A+A/619/A155/tableb1', label: 'Oelkers+2018', type: 'prot' },
                
                // === log(R'HK) catalogs ===
                { catalog: 'J/A+A/551/L8/table2', label: 'Pace2013', type: 'rhk' },
                { catalog: 'J/ApJS/152/261/table3', label: 'Wright+2004', type: 'rhk' },
                { catalog: 'J/A+A/616/A108/catalog', label: 'Boro Saikia+2018', type: 'rhk' },
                { catalog: 'J/MNRAS/403/1368/stars', label: 'Isaacson+2010', type: 'rhk' },
                { catalog: 'J/A+A/520/A79/table2', label: 'Lovis+2011', type: 'rhk' },
                { catalog: 'J/A+A/487/373/table5', label: 'Gray+2006', type: 'rhk' },
                { catalog: 'J/AJ/165/264/table5', label: 'Hebb+2023', type: 'rhk' },
                { catalog: 'J/A+A/562/A124/table1', label: 'Fossati+2017', type: 'rhk' },
                { catalog: 'J/ApJ/766/69/table7', label: 'Knutson+2010', type: 'rhk' },
                
                // === X-ray luminosity catalogs ===
                { catalog: 'J/A+A/450/993/table2', label: 'NEXXUS (Schmitt+2004)', type: 'lx' },
                { catalog: 'J/ApJS/262/14/catalog', label: 'Freund+2022', type: 'lx' },
                { catalog: 'J/A+A/480/735/table2', label: 'Poppenhaeger+2010', type: 'lx' },
                { catalog: 'J/ApJ/669/1167/table1', label: 'Preibisch+2005 (ONC)', type: 'lx' },
                { catalog: 'J/ApJS/160/319/table2', label: 'Getman+2005 (COUP)', type: 'lx' },
                { catalog: 'IX/68/xray', label: 'ROSAT PSPC', type: 'lx' },
            ];

            // Column name patterns for each type
            const liPatterns = ['^EWLi$', '^EW_?Li', '^EW$', '^A_?Li', '^ALi', '^A\\(Li\\)', 'Lith', 'LiEW'];
            const protPatterns = ['^Prot$', '^P_?rot', '^Per$', '^Period$', 'Prot', 'Period'];
            const rhkPatterns = ['logR.*HK', 'log_?R.*HK', 'logRhk', 'R_?HK', 'logRpHK', "logR'HK", 'RHK', 'Rphk', 'S_MW', 'S_index', 'logR5'];
            const lxPatterns = ['^Lx$', '^L_?[Xx]', '^logLx', '^log_?L_?[Xx]', 'LX', 'Lum.*X', 'logL_X'];

            console.log(`Searching ${catalogs.length} Vizier catalogs for youth indicators at RA=${ra.toFixed(5)}, Dec=${dec.toFixed(5)}...`);

            // Query all catalogs in parallel (in batches to avoid overwhelming)
            const batchSize = 6;
            for (let i = 0; i < catalogs.length; i += batchSize) {
                const batch = catalogs.slice(i, i + batchSize);
                const promises = batch.map(cat => queryVizierCatalog(cat.catalog, cat.label).then(r => r ? { ...r, type: cat.type } : null));
                const batchResults = await Promise.all(promises);

                for (const result of batchResults) {
                    if (!result) continue;

                    const { metadata, rows, label, type } = result;
                    const row = rows[0]; // Use first match
                    const catalogId = findCatalogId(metadata, row);

                    if (type === 'li') {
                        const found = findColumnValue(metadata, row, liPatterns);
                        if (found && found.value > 0 && found.value < 500) { // reasonable EW(Li) range in mA
                            results.ewli.push({
                                value: found.value,
                                error: found.error,
                                source: label,
                                catalog: catalogs.find(c => c.label === label)?.catalog,
                                catalogId: catalogId,
                                colName: found.colName
                            });
                            console.log(`  â†’ Li: ${found.value.toFixed(1)} mÃ… from ${label} (col: ${found.colName})${catalogId ? ` [${catalogId}]` : ''}`);
                        }
                    } else if (type === 'prot') {
                        const found = findColumnValue(metadata, row, protPatterns);
                        if (found && found.value > 0.1 && found.value < 200) { // reasonable Prot range in days
                            results.prot.push({
                                value: found.value,
                                error: found.error,
                                source: label,
                                catalog: catalogs.find(c => c.label === label)?.catalog,
                                catalogId: catalogId,
                                colName: found.colName
                            });
                            console.log(`  â†’ Prot: ${found.value.toFixed(2)} d from ${label} (col: ${found.colName})${catalogId ? ` [${catalogId}]` : ''}`);
                        }
                    } else if (type === 'rhk') {
                        const found = findColumnValue(metadata, row, rhkPatterns);
                        if (found) {
                            let val = found.value;
                            if (val > 0) val = -val; // Ensure negative
                            if (val < -3 && val > -6) { // reasonable log(R'HK) range
                                results.rhk.push({
                                    value: val,
                                    error: found.error,
                                    source: label,
                                    catalog: catalogs.find(c => c.label === label)?.catalog,
                                    catalogId: catalogId,
                                    colName: found.colName
                                });
                                console.log(`  â†’ log(R'HK): ${val.toFixed(3)} from ${label} (col: ${found.colName})${catalogId ? ` [${catalogId}]` : ''}`);
                            }
                        }
                    } else if (type === 'lx') {
                        const found = findColumnValue(metadata, row, lxPatterns);
                        if (found) {
                            let val = found.value;
                            let isLog = found.colName.toLowerCase().includes('log');
                            // Determine if value is log or linear
                            // log(Lx) typically 26-32, Lx typically 1e26-1e32
                            if (!isLog && val > 100) {
                                // Likely linear Lx in erg/s, convert to log
                                val = Math.log10(val);
                                isLog = true;
                            }
                            if (isLog && val > 25 && val < 35) { // reasonable log(Lx) range
                                results.lx.push({
                                    value: val,
                                    error: found.error,
                                    source: label,
                                    catalog: catalogs.find(c => c.label === label)?.catalog,
                                    catalogId: catalogId,
                                    colName: found.colName,
                                    isLog: true
                                });
                                console.log(`  â†’ log(Lx): ${val.toFixed(2)} from ${label} (col: ${found.colName})${catalogId ? ` [${catalogId}]` : ''}`);
                            } else if (!isLog && val > 0) {
                                // Store as-is if we can't determine format
                                results.lx.push({
                                    value: val,
                                    error: found.error,
                                    source: label,
                                    catalog: catalogs.find(c => c.label === label)?.catalog,
                                    catalogId: catalogId,
                                    colName: found.colName,
                                    isLog: false
                                });
                                console.log(`  â†’ Lx: ${val.toExponential(2)} erg/s from ${label} (col: ${found.colName})${catalogId ? ` [${catalogId}]` : ''}`);
                            }
                        }
                    }
                }
            }

            console.log(`Youth indicator search complete: ${results.ewli.length} Li, ${results.prot.length} Prot, ${results.rhk.length} R'HK, ${results.lx.length} Lx`);
            return results;
        }

        async function resolveIdentifier(input) {
            // Check if input looks like a Gaia DR3 source_id (all digits, typically 19 digits)
            const cleaned = input.trim();
            
            // First, check if user included "Gaia DR3" prefix (case insensitive, flexible spacing)
            const gaiaMatch = cleaned.match(/^Gaia\s*DR3\s*(\d+)$/i);
            if (gaiaMatch) {
                return { gaiaId: gaiaMatch[1], resolvedName: null, ra: null, dec: null };
            }
            
            // Check if input is just digits (raw Gaia source_id)
            if (/^\d{10,25}$/.test(cleaned)) {
                return { gaiaId: cleaned, resolvedName: null, ra: null, dec: null };
            }
            
            // Generate name variants to try (SIMBAD can be picky about formatting)
            function generateVariants(name) {
                const variants = new Set();
                variants.add(name);
                
                // Try with hyphen instead of space: "Kelt 20" -> "Kelt-20"
                variants.add(name.replace(/\s+/g, '-'));
                
                // Try with space instead of hyphen: "Kelt-20" -> "Kelt 20"
                variants.add(name.replace(/-/g, ' '));
                
                // Try uppercase prefix: "kelt-20" -> "KELT-20"
                const upperMatch = name.match(/^([a-zA-Z]+)([\s-]?)(\d+.*)$/);
                if (upperMatch) {
                    const prefix = upperMatch[1].toUpperCase();
                    const sep = upperMatch[2] || '-';
                    const suffix = upperMatch[3];
                    variants.add(prefix + sep + suffix);
                    variants.add(prefix + '-' + suffix);
                    variants.add(prefix + ' ' + suffix);
                }
                
                // Try without space between letters and numbers: "HD 63433" -> "HD63433"
                variants.add(name.replace(/([a-zA-Z])\s+(\d)/g, '$1$2'));
                
                // Try with space between letters and numbers: "HD63433" -> "HD 63433"
                variants.add(name.replace(/([a-zA-Z])(\d)/g, '$1 $2'));
                
                // Standard catalog prefixes that should be uppercase
                const catalogPrefixes = [
                    // Common stellar catalogs
                    'HD', 'HIP', 'TYC', 'GJ', 'LHS', 'LP', 'BD', 'CD', 'CPD', 'HR',
                    // Exoplanet surveys
                    'TIC', 'TOI', 'KELT', 'WASP', 'HAT', 'HATS', 'EPIC', 'KIC', 'KOI', 'TRAPPIST',
                    // X-ray and high-energy surveys
                    'COUP', 'CXO', 'XMM', 'ROSAT', 'CXOU', '2CXO',
                    // Infrared surveys  
                    '2MASS', 'WISE', 'IRAS',
                    // Young star / cluster catalogs
                    'V*', 'NGC', 'IC', 'Cl*', 'NAME',
                    // Other common prefixes
                    'Wolf', 'Ross', 'Proxima', 'Barnard'
                ];
                for (const prefix of catalogPrefixes) {
                    const regex = new RegExp(`^${prefix.replace(/[*]/g, '\\*')}[\\s-]?(\\S+.*)$`, 'i');
                    const match = name.match(regex);
                    if (match) {
                        variants.add(`${prefix} ${match[1]}`);
                        variants.add(`${prefix}-${match[1]}`);
                        variants.add(`${prefix}${match[1]}`);
                    }
                }
                
                return Array.from(variants);
            }
            
            const variants = generateVariants(cleaned);
            console.log('Trying SIMBAD name variants:', variants);
            
            // Try each variant until one works
            for (const variant of variants) {
                const simbadResult = await resolveSimbad(variant);
                if (simbadResult && simbadResult.gaiaId) {
                    console.log(`âœ“ Resolved "${variant}" to Gaia DR3 ${simbadResult.gaiaId}`);
                    return { 
                        gaiaId: simbadResult.gaiaId, 
                        resolvedName: variant,
                        ra: simbadResult.ra,
                        dec: simbadResult.dec
                    };
                }
            }
            
            return null;
        }

        // Aladin Lite viewer instance
        let aladinViewer = null;

        function initAladinViewer(ra, dec, distancePc = null, searchRadiusPc = null) {
            // Clear any existing viewer
            const container = document.getElementById('aladin-lite-div');
            container.innerHTML = '';
            
            // Calculate FOV based on angular size of search radius at target distance
            // Î¸ = arctan(searchRadius / distance) gives the angular radius in radians
            let fovDeg;
            let fovDisplay;
            
            if (distancePc && distancePc > 0 && searchRadiusPc && searchRadiusPc > 0) {
                // Calculate angular radius of search sphere at target distance
                const angularRadiusRad = Math.atan(searchRadiusPc / distancePc);
                const angularRadiusDeg = angularRadiusRad * 180 / Math.PI;
                
                // FOV should be ~2.2x the angular radius to show the full search area with margin
                fovDeg = angularRadiusDeg * 2.2;
                
                // Cap at reasonable values
                fovDeg = Math.min(fovDeg, 60); // Max 60 degrees
                fovDeg = Math.max(fovDeg, 0.05); // Min 3 arcmin
                
                // Format display string
                if (angularRadiusDeg >= 1) {
                    fovDisplay = `${angularRadiusDeg.toFixed(1)}Â° search radius (${searchRadiusPc} pc at d=${distancePc.toFixed(1)} pc)`;
                } else {
                    fovDisplay = `${(angularRadiusDeg * 60).toFixed(1)}' search radius (${searchRadiusPc} pc at d=${distancePc.toFixed(1)} pc)`;
                }
                
                console.log(`Aladin FOV: Î¸ = arctan(${searchRadiusPc}/${distancePc.toFixed(1)}) = ${angularRadiusDeg.toFixed(2)}Â° â†’ FOV = ${fovDeg.toFixed(2)}Â°`);
            } else if (distancePc && distancePc > 0) {
                // Have distance but no search radius yet - use small default FOV
                fovDeg = 0.1; // 6 arcmin
                fovDisplay = `6' FOV (d = ${distancePc.toFixed(1)} pc)`;
            } else {
                // Initial view without distance info
                fovDeg = 0.083; // 5 arcmin default
                fovDisplay = `5' (initial view)`;
            }
            
            // Initialize Aladin Lite
            aladinViewer = A.aladin('#aladin-lite-div', {
                target: `${ra} ${dec}`,
                fov: fovDeg,
                survey: 'P/DSS2/color',
                showReticle: true,
                showZoomControl: true,
                showFullscreenControl: true,
                showLayersControl: true,
                showGotoControl: false,
                showFrame: true,
                reticleColor: '#22d3ee',
                reticleSize: 22
            });
            
            // Add target marker
            const catalog = A.catalog({ name: 'Target', sourceSize: 18, color: '#ef4444' });
            aladinViewer.addCatalog(catalog);
            catalog.addSources([A.marker(ra, dec, { popupTitle: 'Target', popupDesc: `RA: ${ra.toFixed(5)}Â°, Dec: ${dec.toFixed(5)}Â°` })]);
            
            // Update FoV info
            const fovInfo = document.getElementById('fov-value');
            fovInfo.textContent = fovDisplay;
        }

        function updateAladinSearchRadius(ra, dec, fovDeg, searchRadiusPc) {
            // Update the Aladin viewer to show the search radius
            if (aladinViewer) {
                // Set FOV to show the search circle with some margin
                aladinViewer.setFoV(Math.max(fovDeg * 2.2, 0.01));
                
                // Add search radius circle
                const overlay = A.graphicOverlay({ color: '#22d3ee', lineWidth: 2 });
                aladinViewer.addOverlay(overlay);
                overlay.add(A.circle(ra, dec, fovDeg, { color: '#22d3ee', lineWidth: 2, fill: false }));
                
                // Update FoV info
                const fovInfo = document.getElementById('fov-value');
                if (fovDeg >= 1) {
                    fovInfo.textContent = `${fovDeg.toFixed(1)}Â° (${searchRadiusPc} pc search radius)`;
                } else if (fovDeg >= 1/60) {
                    fovInfo.textContent = `${(fovDeg * 60).toFixed(1)}' (${searchRadiusPc} pc search radius)`;
                } else {
                    fovInfo.textContent = `${(fovDeg * 3600).toFixed(0)}" (${searchRadiusPc} pc search radius)`;
                }
            }
        }

        function displayExternalLinks(target, resolvedName) {
            const container = document.getElementById('external-links');
            const sourceId = target.source_id;
            const ra = target.ra;
            const dec = target.dec;
            
            // Build identifier for SIMBAD (prefer resolved name, fallback to Gaia ID)
            const simbadId = resolvedName || `Gaia DR3 ${sourceId}`;
            const simbadUrl = `https://simbad.cds.unistra.fr/simbad/sim-id?Ident=${encodeURIComponent(simbadId)}`;
            
            // ExoFOP-TESS search by coordinates
            const exofopUrl = `https://exofop.ipac.caltech.edu/tess/target.php?id=${encodeURIComponent(simbadId)}`;
            
            // VizieR photometry search
            const vizierUrl = `https://vizier.cds.unistra.fr/viz-bin/VizieR-4?-source=&-out.add=_r&-out.add=_RAJ%2C_DEJ&-sort=_r&-c=${ra}+${dec}&-c.rs=5`;
            
            container.innerHTML = `
                <a href="${simbadUrl}" target="_blank" class="external-link" title="View in SIMBAD">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    SIMBAD
                </a>
                <a href="${exofopUrl}" target="_blank" class="external-link" title="View in ExoFOP-TESS">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="4"></circle>
                        <line x1="21.17" y1="8" x2="12" y2="8"></line>
                        <line x1="3.95" y1="6.06" x2="8.54" y2="14"></line>
                        <line x1="10.88" y1="21.94" x2="15.46" y2="14"></line>
                    </svg>
                    ExoFOP
                </a>
                <a href="${vizierUrl}" target="_blank" class="external-link" title="Search VizieR">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                        <path d="M3 9h18M9 21V9"></path>
                    </svg>
                    VizieR
                </a>
            `;
        }

        async function checkExoplanetArchive(ra, dec, resolvedName) {
            // Query NASA Exoplanet Archive for confirmed planets
            // Use TAP service with cone search
            const radiusDeg = 5 / 3600; // 5 arcsec
            
            try {
                // Query the Planetary Systems table
                const url = `https://exoplanetarchive.ipac.caltech.edu/TAP/sync?query=SELECT+hostname,pl_name,pl_rade,pl_bmasse,pl_orbper,disc_year+FROM+ps+WHERE+1=CONTAINS(POINT('ICRS',ra,dec),CIRCLE('ICRS',${ra},${dec},${radiusDeg}))&format=json`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    console.warn('Exoplanet Archive query failed');
                    return null;
                }
                
                const data = await response.json();
                if (data && data.length > 0) {
                    console.log(`âœ“ Found ${data.length} confirmed exoplanet(s) at this position`);
                    return data;
                }
                
                // Also try by name if we have one
                if (resolvedName) {
                    const nameClean = resolvedName.replace(/[^a-zA-Z0-9\s-]/g, '').trim();
                    const nameUrl = `https://exoplanetarchive.ipac.caltech.edu/TAP/sync?query=SELECT+hostname,pl_name,pl_rade,pl_bmasse,pl_orbper,disc_year+FROM+ps+WHERE+hostname+LIKE+'%25${encodeURIComponent(nameClean)}%25'&format=json`;
                    
                    const nameResponse = await fetch(nameUrl);
                    if (nameResponse.ok) {
                        const nameData = await nameResponse.json();
                        if (nameData && nameData.length > 0) {
                            console.log(`âœ“ Found ${nameData.length} confirmed exoplanet(s) by name`);
                            return nameData;
                        }
                    }
                }
                
                return null;
            } catch (e) {
                console.warn('Exoplanet Archive query error:', e);
                return null;
            }
        }

        function displayExoplanetAlert(planets) {
            const container = document.getElementById('exoplanet-alert');
            if (!planets || planets.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Get unique planet names
            const uniquePlanets = [...new Set(planets.map(p => p.pl_name))];
            const hostname = planets[0].hostname;
            
            const planetList = uniquePlanets.map(name => {
                const p = planets.find(pl => pl.pl_name === name);
                let details = [];
                if (p.pl_orbper) details.push(`P=${p.pl_orbper.toFixed(2)}d`);
                if (p.pl_rade) details.push(`R=${p.pl_rade.toFixed(2)}RâŠ•`);
                if (p.disc_year) details.push(`(${p.disc_year})`);
                return `<strong>${name}</strong>${details.length > 0 ? ': ' + details.join(', ') : ''}`;
            }).join('<br>');
            
            container.innerHTML = `
                <div style="background: rgba(251, 191, 36, 0.15); border: 1px solid var(--accent-orange); border-radius: 6px; padding: 0.75rem; margin-top: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-orange)" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 2v2M12 20v2M2 12h2M20 12h2"></path>
                        </svg>
                        <span style="color: var(--accent-orange); font-weight: 600;">Confirmed Exoplanet Host!</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${planetList}
                    </div>
                    <a href="https://exoplanetarchive.ipac.caltech.edu/overview/${encodeURIComponent(hostname)}" target="_blank" 
                       style="display: inline-block; margin-top: 0.5rem; font-size: 0.8rem; color: var(--accent-cyan);">
                        View on NASA Exoplanet Archive â†’
                    </a>
                </div>
            `;
        }

        function addComovingToAladin(candidates) {
            // Add comoving members as X markers on Aladin
            if (!aladinViewer || candidates.length === 0) return;
            
            // Filter out the target itself and ensure we have coordinates
            const comovers = candidates.filter(c => c.sep_3d > 0.01 && c.ra != null && c.dec != null);
            
            if (comovers.length === 0) return;
            
            // Create a catalog for comoving members
            const comovingCatalog = A.catalog({
                name: 'Comoving',
                sourceSize: 12,
                color: '#22d3ee',
                shape: 'cross'  // X marker
            });
            aladinViewer.addCatalog(comovingCatalog);
            
            // Add sources
            const sources = comovers.map(c => {
                return A.source(c.ra, c.dec, {
                    name: `Gaia DR3 ${c.source_id}`,
                    popupTitle: `Gaia DR3 ${c.source_id}`,
                    popupDesc: `Sep: ${c.sep_3d?.toFixed(2)} pc<br>V_off: ${c.voff?.toFixed(2)} km/s<br>G: ${c.phot_g_mean_mag?.toFixed(2)}`
                });
            });
            comovingCatalog.addSources(sources);
            
            console.log(`Added ${comovers.length} comoving members to Aladin`);
        }

        async function queryVizier(catalog, constraints, columns = '*') {
            // Use Vizier TAP service
            const url = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';
            const query = `SELECT ${columns} FROM "${catalog}" WHERE ${constraints}`;
            
            const params = new URLSearchParams({
                REQUEST: 'doQuery',
                LANG: 'ADQL',
                FORMAT: 'json',
                QUERY: query
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                if (!response.ok) return null;
                return await response.json();
            } catch (e) {
                console.warn('Vizier query failed:', e);
                return null;
            }
        }

        async function searchRotationPeriods(ra, dec, sourceId) {
            const results = [];
            const radiusDeg = 5 / 3600; // 5 arcsec in degrees

            // List of rotation period catalogs to search
            const catalogs = [
                { name: 'J/ApJS/250/20/table1', periodCol: 'Prot', errCol: 'e_Prot', label: 'Canto Martins+2020' },
                { name: 'J/ApJS/211/24/table1', periodCol: 'Prot', errCol: 'e_Prot', label: 'McQuillan+2014' },
                { name: 'J/ApJS/244/21/table2', periodCol: 'Prot', errCol: 'e_Prot', label: 'Santos+2019' },
                { name: 'J/A+A/635/A43/tableb1', periodCol: 'Prot', errCol: null, label: 'Reinhold+2020' },
                { name: 'J/ApJ/913/70/table1', periodCol: 'Prot', errCol: 'e_Prot', label: 'Gordon+2021' },
                { name: 'J/ApJS/271/51/table1', periodCol: 'Prot', errCol: 'E_Prot', label: 'Claytor+2024' },
                { name: 'J/ApJ/879/49/table1', periodCol: 'Prot', errCol: 'e_Prot', label: 'Curtis+2019' },
                { name: 'J/AJ/158/77/table1', periodCol: 'Prot', errCol: 'e_Prot', label: 'Douglas+2019' },
                { name: 'J/A+A/619/A155/tableb1', periodCol: 'Prot', errCol: null, label: 'Oelkers+2018' },
            ];
            
            // ID column patterns to look for
            const idPatterns = [
                { pattern: /^TIC$/i, prefix: 'TIC ' },
                { pattern: /^KIC$/i, prefix: 'KIC ' },
                { pattern: /^EPIC$/i, prefix: 'EPIC ' },
                { pattern: /^KOI$/i, prefix: 'KOI ' },
                { pattern: /^HD$/i, prefix: 'HD ' },
                { pattern: /^HIP$/i, prefix: 'HIP ' },
                { pattern: /^COUP$/i, prefix: 'COUP ' },
                { pattern: /^2MASS$/i, prefix: '2MASS ' },
                { pattern: /^Gaia$/i, prefix: 'Gaia DR3 ' },
                { pattern: /^Source$/i, prefix: 'Gaia DR3 ' },
                { pattern: /^Name$/i, prefix: '' },
                { pattern: /^ID$/i, prefix: '' },
                { pattern: /^Star$/i, prefix: '' },
                { pattern: /^Seq$/i, prefix: '' },
            ];

            for (const cat of catalogs) {
                try {
                    // Use VizieR cone search
                    const url = `https://vizier.cds.unistra.fr/viz-bin/conesearch/${cat.name}?RA=${ra}&DEC=${dec}&SR=${radiusDeg}&VERB=3`;
                    const response = await fetch(url);
                    
                    if (!response.ok) continue;
                    
                    const text = await response.text();
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');
                    
                    const fields = xml.querySelectorAll('FIELD');
                    const metadata = Array.from(fields).map(f => ({ name: f.getAttribute('name') || f.getAttribute('ID') }));
                    
                    const trs = xml.querySelectorAll('TABLEDATA TR');
                    if (trs.length === 0) continue;
                    
                    const row = Array.from(trs[0].querySelectorAll('TD')).map(td => {
                        const val = td.textContent.trim();
                        const num = parseFloat(val);
                        return isNaN(num) ? val : num;
                    });
                    
                    // Find catalog ID
                    let catalogId = null;
                    for (const { pattern, prefix } of idPatterns) {
                        const colIdx = metadata.findIndex(m => pattern.test(m.name));
                        if (colIdx >= 0 && row[colIdx] != null && row[colIdx] !== '') {
                            catalogId = prefix + String(row[colIdx]).trim();
                            break;
                        }
                    }
                    
                    // Find period column
                    let periodIdx = metadata.findIndex(m => m.name === cat.periodCol);
                    if (periodIdx < 0) {
                        periodIdx = metadata.findIndex(m => /^P(rot|er(iod)?)?$/i.test(m.name));
                    }
                    const errIdx = cat.errCol ? metadata.findIndex(m => m.name === cat.errCol) : -1;
                    
                    if (periodIdx >= 0 && row[periodIdx] != null) {
                        const period = parseFloat(row[periodIdx]);
                        if (!isNaN(period) && period > 0.1 && period < 200) {
                            results.push({
                                period: period,
                                error: errIdx >= 0 && row[errIdx] != null ? parseFloat(row[errIdx]) : null,
                                source: cat.label,
                                catalog: cat.name,
                                catalogId: catalogId
                            });
                            console.log(`âœ“ Prot from ${cat.label}: ${period.toFixed(2)} d${catalogId ? ` [${catalogId}]` : ''}`);
                        }
                    }
                } catch (e) {
                    // Continue to next catalog
                }
            }

            return results;
        }

        async function searchLithiumEW(sourceId) {
            // Search Gaia DR3 astrophysical parameters for EW_Li
            // Also search external catalogs
            const results = [];

            // Try Vizier catalogs with lithium measurements
            const liCatalogs = [
                { name: 'J/A+A/649/A6/table1', ewCol: 'EWLi', errCol: 'e_EWLi', label: 'Gaia DR3 GSP-Spec' },
                { name: 'J/A+A/664/A78/table3', ewCol: 'EW_Li_', errCol: 'e_EW_Li_', label: 'GALAH DR3' }
            ];

            return results;
        }

        function computeVelocityDiff(star, target) {
            // Simplified velocity difference calculation
            // In reality, this requires full 3D velocity computation
            const dpmra = star.pmra - target.pmra;
            const dpmdec = star.pmdec - target.pmdec;
            const dist = 1000 / star.parallax; // pc
            
            // Convert proper motion difference to tangential velocity
            // 1 mas/yr at 1 pc = 4.74 km/s
            const vtan = Math.sqrt(dpmra * dpmra + dpmdec * dpmdec) * 4.74 * dist / 1000;
            return vtan;
        }

        function getSpectralType(bprp) {
            if (bprp == null || isNaN(bprp)) return 'N/A';
            
            // Linear interpolation
            for (let i = 0; i < sptMapping.length - 1; i++) {
                if (bprp >= sptMapping[i].bprp && bprp < sptMapping[i + 1].bprp) {
                    return sptMapping[i].spt;
                }
            }
            if (bprp < sptMapping[0].bprp) return 'B/A';
            if (bprp >= sptMapping[sptMapping.length - 1].bprp) return 'M8+';
            return 'N/A';
        }
        
        // Estimate stellar mass from BP-RP color or Teff
        // Based on Pecaut & Mamajek (2013) and Mann+2019 for M dwarfs
        function estimateMass(bprp, teff) {
            // Mass-color relation data points (BP-RP, Mass in Msun)
            // From Pecaut & Mamajek (2013) dwarf sequence + Mann+2019 for M dwarfs
            const massMapping = [
                { bprp: -0.05, mass: 2.0, spt: 'A0' },
                { bprp: 0.18, mass: 1.6, spt: 'A5' },
                { bprp: 0.35, mass: 1.4, spt: 'F0' },
                { bprp: 0.50, mass: 1.2, spt: 'F5' },
                { bprp: 0.65, mass: 1.05, spt: 'G0' },
                { bprp: 0.82, mass: 1.0, spt: 'G2 (Sun)' },
                { bprp: 0.95, mass: 0.9, spt: 'G8' },
                { bprp: 1.15, mass: 0.8, spt: 'K2' },
                { bprp: 1.40, mass: 0.7, spt: 'K5' },
                { bprp: 1.85, mass: 0.55, spt: 'M0' },
                { bprp: 2.20, mass: 0.45, spt: 'M2' },
                { bprp: 2.70, mass: 0.30, spt: 'M4' },
                { bprp: 3.30, mass: 0.15, spt: 'M6' },
                { bprp: 4.00, mass: 0.08, spt: 'M8' },
            ];
            
            let mass = null;
            let source = null;
            
            // First try from Teff if available (more reliable)
            if (teff && teff > 2500 && teff < 10000) {
                // Teff-Mass relation (simplified, for main sequence)
                // log(M) â‰ˆ a + b*log(Teff) for MS stars
                if (teff >= 3000) {
                    // For FGK stars: Boyajian+2012, Torres+2010
                    const logT = Math.log10(teff);
                    // Empirical fit for MS: M â‰ˆ (Teff/5777)^1.8 roughly
                    mass = Math.pow(teff / 5772, 1.8);
                    if (mass > 2.5) mass = null; // Out of valid range
                    else source = 'Teff (Boyajian+2012)';
                } else {
                    // For M dwarfs: Mann+2019
                    mass = Math.pow(teff / 4000, 2.5) * 0.6;
                    source = 'Teff (Mann+2019)';
                }
            }
            
            // Fall back to BP-RP if no Teff mass
            if (!mass && bprp != null && !isNaN(bprp) && bprp > -0.1 && bprp < 4.5) {
                // Linear interpolation in mass mapping
                for (let i = 0; i < massMapping.length - 1; i++) {
                    if (bprp >= massMapping[i].bprp && bprp < massMapping[i + 1].bprp) {
                        const frac = (bprp - massMapping[i].bprp) / (massMapping[i + 1].bprp - massMapping[i].bprp);
                        mass = massMapping[i].mass + frac * (massMapping[i + 1].mass - massMapping[i].mass);
                        source = 'BP-RP (Pecaut+2013)';
                        break;
                    }
                }
                if (!mass && bprp < massMapping[0].bprp) {
                    mass = 2.0;
                    source = 'BP-RP (extrapolated)';
                }
                if (!mass && bprp >= massMapping[massMapping.length - 1].bprp) {
                    mass = 0.08;
                    source = 'BP-RP (extrapolated)';
                }
            }
            
            return mass ? { value: mass, source: source } : null;
        }

        function calculateAbsMag(gmag, parallax) {
            if (parallax <= 0) return null;
            const dist = 1000 / parallax; // pc
            return gmag - 5 * Math.log10(dist) + 5;
        }

        async function runSearch() {
            const inputId = document.getElementById('target-id').value.trim();
            if (!inputId) {
                setStatus('Please enter a Gaia DR3 Source ID or SIMBAD identifier', 'error');
                return;
            }

            const velocityLimit = parseFloat(document.getElementById('velocity-limit').value) || 5.0;
            const searchRadius = parseFloat(document.getElementById('search-radius').value) || 25.0;
            const rvCut = parseFloat(document.getElementById('rv-cut').value) || 5.0;

            const searchBtn = document.getElementById('search-btn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="loading-spinner"></span> Searching...';
            
            // Show walking astronaut
            document.getElementById('walking-loader').classList.add('active');

            document.getElementById('results-section').classList.remove('visible');
            searchResults = [];
            rotationPeriods = {};

            let gaiaId = null;
            let resolvedName = null;
            let vizierYouthData = { ewli: [], prot: [], rhk: [] };
            let simbadCoords = null;

            try {
                // Step 0: Resolve identifier
                updateProgress([
                    { text: 'Resolving target identifier...', status: 'active' },
                    { text: 'Searching Vizier for youth indicators', status: 'pending' },
                    { text: 'Querying Gaia DR3 for target', status: 'pending' },
                    { text: 'Searching for comoving companions', status: 'pending' },
                    { text: 'Searching Vizier for rotation periods', status: 'pending' }
                ]);
                setStatus('Resolving target identifier...');

                const resolved = await resolveIdentifier(inputId);
                
                if (!resolved) {
                    throw new Error(`Could not resolve "${inputId}" to a Gaia DR3 source. Try entering the Gaia DR3 source_id directly.`);
                }
                
                gaiaId = resolved.gaiaId;
                resolvedName = resolved.resolvedName;
                simbadCoords = (resolved.ra != null && resolved.dec != null) ? { ra: resolved.ra, dec: resolved.dec } : null;

                if (resolvedName) {
                    setStatus(`Resolved "${resolvedName}" to Gaia DR3 ${gaiaId}`);
                }

                // If we have SIMBAD coordinates, immediately show Aladin and search Vizier
                if (simbadCoords) {
                    document.getElementById('results-section').classList.add('visible');
                    
                    // Show preliminary info
                    document.getElementById('target-info').innerHTML = `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="label">Name</div>
                            <div class="value highlight" style="font-size: 1.1rem;">${resolvedName}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Gaia DR3 Source ID</div>
                            <div class="value">${gaiaId}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">RA / Dec (SIMBAD)</div>
                            <div class="value">${simbadCoords.ra.toFixed(5)}Â° / ${simbadCoords.dec.toFixed(5)}Â°</div>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="label" style="color: var(--accent-cyan);">Loading Gaia data...</div>
                        </div>
                    `;
                    
                    // Show Aladin immediately with SIMBAD coordinates
                    initAladinViewer(targetData.ra, targetData.dec);
                    displayGalacticMap(targetData.ra, targetData.dec);
                    displayToomreDiagram(targetData);
                    displayCMD([], targetData);  // Show CMD with just the target star initially
                    
                    // Placeholder for external links (will update after Gaia query)
                    document.getElementById('external-links').innerHTML = '<span style="color: var(--text-muted);">Loading...</span>';
                    
                    // Placeholders for youth indicators
                    document.getElementById('li-values').innerHTML = '<div class="no-data">Searching Vizier...</div>';
                    document.getElementById('rotation-results').innerHTML = '<div class="no-data">Searching...</div>';
                    document.getElementById('rhk-results').innerHTML = '<div class="no-data">Searching...</div>';
                    document.getElementById('lx-results').innerHTML = '<div class="no-data">Searching...</div>';

                    // Step 1: Search Vizier for youth indicators FIRST (using SIMBAD coordinates)
                    updateProgress([
                        { text: resolvedName ? `Resolved "${resolvedName}" â†’ Gaia DR3 ${gaiaId}` : 'Using Gaia DR3 ID', status: 'check' },
                        { text: 'Searching Vizier for youth indicators...', status: 'active' },
                        { text: 'Querying Gaia DR3 for target', status: 'pending' },
                        { text: 'Searching for comoving companions', status: 'pending' },
                        { text: 'Searching Vizier for rotation periods', status: 'pending' }
                    ]);
                    setStatus('Searching Vizier for youth indicators (EW Li, Prot, log R\'HK, Lx)...');

                    vizierYouthData = await queryVizierYouthIndicators(simbadCoords.ra, simbadCoords.dec);
                    const youthFound = vizierYouthData.ewli.length + vizierYouthData.prot.length + vizierYouthData.rhk.length + vizierYouthData.lx.length;
                    
                    // Update youth indicators display immediately
                    displayYouthIndicators(vizierYouthData, null, []);
                }

                // Step 2: Query Gaia for full target data
                updateProgress([
                    { text: resolvedName ? `Resolved "${resolvedName}" â†’ Gaia DR3 ${gaiaId}` : 'Using Gaia DR3 ID', status: 'check' },
                    { text: simbadCoords ? `Found ${vizierYouthData.ewli.length + vizierYouthData.prot.length + vizierYouthData.rhk.length + vizierYouthData.lx.length} youth indicator(s)` : 'Searching Vizier for youth indicators', status: simbadCoords ? 'check' : 'pending' },
                    { text: 'Querying Gaia DR3 for target...', status: 'active' },
                    { text: 'Searching for comoving companions', status: 'pending' },
                    { text: 'Searching Vizier for rotation periods', status: 'pending' }
                ]);
                setStatus('Querying Gaia DR3 via VizieR...');

                const targetQuery = `SELECT source_id, ra, dec, parallax, parallax_error, pmra, pmdec, 
                    radial_velocity, radial_velocity_error, phot_g_mean_mag, phot_bp_mean_mag, 
                    phot_rp_mean_mag, bp_rp, ruwe, teff_gspphot, logg_gspphot
                    FROM gaiadr3.gaia_source WHERE source_id = ${gaiaId}`;

                const targetResult = await queryGaia(targetQuery);
                
                if (!targetResult.data || targetResult.data.length === 0) {
                    throw new Error(`No source found with Gaia DR3 ID: ${gaiaId}`);
                }

                // Store resolved name for display
                if (resolvedName) {
                    targetData = { _resolvedName: resolvedName };
                } else {
                    targetData = {};
                }

                // Parse target data
                const cols = targetResult.metadata.map(m => m.name);
                const row = targetResult.data[0];
                cols.forEach((col, i) => { targetData[col.toLowerCase()] = row[i]; });

                if (!targetData.parallax || targetData.parallax <= 0) {
                    throw new Error('Target has no valid parallax');
                }

                // Now show full results section with Gaia data
                document.getElementById('results-section').classList.add('visible');
                displayTargetInfo(targetData, null);
                displayExternalLinks(targetData, resolvedName);
                
                // Compute distance from parallax
                const targetDist = 1000 / targetData.parallax; // pc
                
                // Show CMD immediately with just target star (no candidates yet)
                displayCMD([], targetData);
                
                // Update Aladin with Gaia coordinates and appropriate zoom for search radius
                initAladinViewer(targetData.ra, targetData.dec, targetDist, searchRadius);

                // If we didn't search Vizier yet (no SIMBAD coords), do it now
                if (!simbadCoords) {
                    document.getElementById('li-values').innerHTML = '<div class="no-data">Searching Vizier...</div>';
                    document.getElementById('rotation-results').innerHTML = '<div class="no-data">Searching...</div>';
                    document.getElementById('rhk-results').innerHTML = '<div class="no-data">Searching...</div>';
                    document.getElementById('lx-results').innerHTML = '<div class="no-data">Searching...</div>';
                    
                    updateProgress([
                        { text: resolvedName ? `Resolved "${resolvedName}" â†’ Gaia DR3 ${gaiaId}` : 'Using Gaia DR3 ID', status: 'check' },
                        { text: 'Searching Vizier for youth indicators...', status: 'active' },
                        { text: 'Target found in Gaia DR3', status: 'check' },
                        { text: 'Searching for comoving companions', status: 'pending' },
                        { text: 'Searching Vizier for rotation periods', status: 'pending' }
                    ]);
                    setStatus('Searching Vizier for youth indicators...');
                    
                    vizierYouthData = await queryVizierYouthIndicators(targetData.ra, targetData.dec);
                }

                const youthFound = vizierYouthData.ewli.length + vizierYouthData.prot.length + vizierYouthData.rhk.length + vizierYouthData.lx.length;
                
                // Calculate angular search radius - handle case where search radius > distance
                // Angular radius = atan(searchRadius / distance) for the projected size
                let searchRadDeg;
                if (searchRadius >= targetDist) {
                    // Search radius larger than distance - use a large angular search
                    searchRadDeg = 60; // 60 degrees max
                } else {
                    // Normal case: angular size of searchRadius pc at targetDist
                    searchRadDeg = Math.atan(searchRadius / targetDist) * 180 / Math.PI;
                }
                console.log(`Search radius: ${searchRadius} pc at ${targetDist.toFixed(1)} pc = ${searchRadDeg.toFixed(2)}Â°`);

                // Step 3: Query neighbors (comoving search)
                updateProgress([
                    { text: resolvedName ? `Resolved "${resolvedName}" â†’ Gaia DR3 ${gaiaId}` : 'Using Gaia DR3 ID', status: 'check' },
                    { text: 'Target found in Gaia DR3', status: 'check' },
                    { text: `Found ${youthFound} youth indicator(s) in Vizier`, status: 'check' },
                    { text: 'Searching for comoving companions...', status: 'active' },
                    { text: 'Searching Vizier for rotation periods', status: 'pending' }
                ]);
                setStatus('Running comoving search...');

                // Update Aladin to show search radius
                updateAladinSearchRadius(targetData.ra, targetData.dec, searchRadDeg, searchRadius);

                const minParallax = 1000 / (targetDist + searchRadius);
                const neighborQuery = `SELECT source_id, ra, dec, parallax, parallax_error, pmra, pmdec,
                    radial_velocity, radial_velocity_error, phot_g_mean_mag, phot_bp_mean_mag,
                    phot_rp_mean_mag, bp_rp, ruwe, teff_gspphot
                    FROM gaiadr3.gaia_source 
                    WHERE CONTAINS(POINT('ICRS', ra, dec), CIRCLE('ICRS', ${targetData.ra}, ${targetData.dec}, ${searchRadDeg})) = 1
                    AND parallax > ${minParallax * 0.5}
                    AND parallax_error < 0.5`;

                const neighborResult = await queryGaia(neighborQuery);
                
                if (!neighborResult.data || neighborResult.data.length === 0) {
                    throw new Error('No neighbors found in search region');
                }

                // Compute kinematics and filter
                const neighborCols = neighborResult.metadata.map(m => m.name);
                const candidates = [];

                for (const nrow of neighborResult.data) {
                    const star = {};
                    neighborCols.forEach((col, i) => { star[col.toLowerCase()] = nrow[i]; });

                    if (!star.parallax || star.parallax <= 0) continue;

                    const starDist = 1000 / star.parallax;
                    
                    // 3D separation
                    const dra = (star.ra - targetData.ra) * Math.cos(targetData.dec * Math.PI / 180);
                    const ddec = star.dec - targetData.dec;
                    const angSep = Math.sqrt(dra * dra + ddec * ddec);
                    const sep3d = Math.sqrt(
                        Math.pow(starDist - targetDist, 2) +
                        Math.pow(angSep * Math.PI / 180 * targetDist, 2)
                    );

                    if (sep3d > searchRadius) continue;

                    // Velocity difference (simplified)
                    const voff = computeVelocityDiff(star, targetData);
                    if (voff > velocityLimit) continue;

                    star.sep_deg = angSep;
                    star.sep_3d = sep3d;
                    star.voff = voff;
                    star.abs_g = calculateAbsMag(star.phot_g_mean_mag, star.parallax);
                    star.spt = getSpectralType(star.bp_rp);

                    candidates.push(star);
                }

                // Sort by 3D separation
                candidates.sort((a, b) => a.sep_3d - b.sep_3d);

                // Add index
                candidates.forEach((c, i) => { c.index = i; });
                searchResults = candidates;

                // Step 4: Search Vizier for additional rotation periods for candidates
                updateProgress([
                    { text: resolvedName ? `Resolved "${resolvedName}"` : 'Using Gaia DR3 ID', status: 'check' },
                    { text: 'Target found, displaying sky view', status: 'check' },
                    { text: `Found ${youthFound} Vizier youth indicator(s)`, status: 'check' },
                    { text: `${candidates.length} comoving candidates found`, status: 'check' },
                    { text: 'Searching Vizier for rotation periods...', status: 'active' }
                ]);
                setStatus('Searching Vizier catalogs for rotation periods...');

                // Search rotation for target and first few candidates
                const targetRot = await searchRotationPeriods(targetData.ra, targetData.dec, targetData.source_id);
                if (targetRot.length > 0) {
                    rotationPeriods[targetData.source_id] = targetRot;
                }

                // Search rotation for top candidates (limit to avoid too many queries)
                const rotSearchLimit = Math.min(candidates.length, 20);
                for (let i = 0; i < rotSearchLimit; i++) {
                    const c = candidates[i];
                    const rot = await searchRotationPeriods(c.ra, c.dec, c.source_id);
                    if (rot.length > 0) {
                        rotationPeriods[c.source_id] = rot;
                    }
                }

                // Query Gaia for lithium EW
                const liQuery = `SELECT ew_espels_li, ew_espels_li_uncertainty, flags_espels
                    FROM gaiadr3.astrophysical_parameters WHERE source_id = ${gaiaId}`;
                
                let gaiaLiData = null;
                try {
                    const liResult = await queryGaia(liQuery);
                    if (liResult.data && liResult.data.length > 0) {
                        const liCols = liResult.metadata.map(m => m.name);
                        gaiaLiData = {};
                        liCols.forEach((col, i) => { gaiaLiData[col.toLowerCase()] = liResult.data[0][i]; });
                    }
                } catch (e) {
                    console.warn('Gaia lithium query failed:', e);
                }

                // Done!
                const totalYouth = youthFound + (gaiaLiData?.ew_espels_li ? 1 : 0) + Object.keys(rotationPeriods).length;
                updateProgress([
                    { text: resolvedName ? `Resolved "${resolvedName}"` : 'Using Gaia DR3 ID', status: 'check' },
                    { text: 'Target found, displaying sky view', status: 'check' },
                    { text: `Found ${youthFound} Vizier youth indicator(s)`, status: 'check' },
                    { text: `${candidates.length} comoving candidates found`, status: 'check' },
                    { text: 'Complete!', status: 'check' }
                ]);

                setStatus(`Found ${candidates.length} comoving candidates within ${searchRadius} pc`, 'success');

                // Update displays with final data
                displayTargetInfo(targetData, gaiaLiData);
                displayYouthIndicators(vizierYouthData, gaiaLiData, rotationPeriods[targetData.source_id] || []);
                displayCMD(candidates, targetData);
                displayTable(candidates);
                
                // Display gyrochronology plot if we have rotation period
                const targetRotPeriods = rotationPeriods[targetData.source_id] || vizierYouthData.prot || [];
                const targetProt = targetRotPeriods.length > 0 ? targetRotPeriods[0].period || targetRotPeriods[0].value : null;
                displayGyroPlot(targetData, targetProt);
                
                // Add comoving members to Aladin
                addComovingToAladin(candidates);
                
                // Check if target is an exoplanet host
                const exoplanets = await checkExoplanetArchive(targetData.ra, targetData.dec, resolvedName);
                displayExoplanetAlert(exoplanets);

            } catch (error) {
                setStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                // Hide walking astronaut
                document.getElementById('walking-loader').classList.remove('active');
                
                searchBtn.disabled = false;
                searchBtn.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Search
                `;
            }
        }

        function displayTargetInfo(target, liData) {
            const container = document.getElementById('target-info');
            const dist = 1000 / target.parallax;
            const absMag = calculateAbsMag(target.phot_g_mean_mag, target.parallax);
            const massEst = estimateMass(target.bp_rp, target.teff_gspphot);

            const nameDisplay = target._resolvedName 
                ? `<div class="info-item" style="grid-column: 1 / -1;">
                       <div class="label">Name</div>
                       <div class="value highlight" style="font-size: 1.1rem;">${target._resolvedName}</div>
                   </div>`
                : '';
            
            const massDisplay = massEst 
                ? `<div class="info-item">
                       <div class="label">Mass Est.</div>
                       <div class="value">${massEst.value.toFixed(2)} M<sub>â˜‰</sub> <span style="font-size: 0.7rem; color: var(--text-muted);">(${massEst.source})</span></div>
                   </div>`
                : '';

            container.innerHTML = `
                ${nameDisplay}
                <div class="info-item">
                    <div class="label">Gaia DR3 Source ID</div>
                    <div class="value">${target.source_id}</div>
                </div>
                <div class="info-item">
                    <div class="label">RA / Dec</div>
                    <div class="value">${target.ra.toFixed(5)}Â° / ${target.dec.toFixed(5)}Â°</div>
                </div>
                <div class="info-item">
                    <div class="label">Distance</div>
                    <div class="value highlight">${dist.toFixed(1)} pc</div>
                </div>
                <div class="info-item">
                    <div class="label">G mag / M<sub>G</sub></div>
                    <div class="value">${target.phot_g_mean_mag?.toFixed(2) || 'N/A'} / ${absMag?.toFixed(2) || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="label">Bp - Rp</div>
                    <div class="value">${target.bp_rp?.toFixed(3) || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="label">Spectral Type</div>
                    <div class="value highlight">${getSpectralType(target.bp_rp)}</div>
                </div>
                <div class="info-item">
                    <div class="label">T<sub>eff</sub></div>
                    <div class="value">${target.teff_gspphot ? Math.round(target.teff_gspphot) + ' K' : 'N/A'}</div>
                </div>
                ${massDisplay}
                <div class="info-item">
                    <div class="label">Radial Velocity</div>
                    <div class="value">${target.radial_velocity != null ? target.radial_velocity.toFixed(2) + ' km/s' : 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="label">RUWE</div>
                    <div class="value">${target.ruwe?.toFixed(2) || 'N/A'}</div>
                </div>
            `;
        }

        function displayYouthIndicators(vizierYouth, gaiaLi, vizierRot) {
            const liContainer = document.getElementById('li-values');
            const rotContainer = document.getElementById('rotation-results');
            const rhkContainer = document.getElementById('rhk-results');
            
            // Helper to create VizieR link
            function vizierLink(catalog, label) {
                if (catalog) {
                    const url = `https://vizier.cds.unistra.fr/viz-bin/VizieR-3?-source=${encodeURIComponent(catalog)}`;
                    return `<a href="${url}" target="_blank" class="source" title="View in VizieR">${label}</a>`;
                }
                return `<span class="source">${label}</span>`;
            }
            
            // Helper to format catalog ID
            function formatCatalogId(catalogId) {
                if (catalogId) {
                    return `<span class="catalog-id" title="Catalog ID">${catalogId}</span>`;
                }
                return '';
            }

            // === LITHIUM ===
            let liHTML = '';
            
            // Add Vizier Li measurements
            if (vizierYouth.ewli && vizierYouth.ewli.length > 0) {
                liHTML += vizierYouth.ewli.map(m => `
                    <div class="youth-item">
                        <span class="value li-color">${m.value.toFixed(1)} mÃ…</span>
                        ${m.error ? `<span class="error">Â±${m.error.toFixed(1)}</span>` : ''}
                        ${formatCatalogId(m.catalogId)}
                        ${vizierLink(m.catalog, m.source)}
                    </div>
                `).join('');
            }
            
            // Add Gaia DR3 Li
            if (gaiaLi && gaiaLi.ew_espels_li != null) {
                liHTML += `
                    <div class="youth-item">
                        <span class="value li-color">${gaiaLi.ew_espels_li.toFixed(1)} mÃ…</span>
                        <span class="error">Â±${gaiaLi.ew_espels_li_uncertainty?.toFixed(1) || '?'}</span>
                        <span class="source">Gaia DR3</span>
                    </div>
                `;
            }
            
            if (liHTML === '') {
                liHTML = '<div class="no-data">No measurements found</div>';
            }
            liContainer.innerHTML = liHTML;

            // === ROTATION ===
            let rotHTML = '';
            
            // Add Vizier rotation periods from youth search
            if (vizierYouth.prot && vizierYouth.prot.length > 0) {
                rotHTML += vizierYouth.prot.map(m => `
                    <div class="youth-item">
                        <span class="value prot-color">${m.value.toFixed(3)} d</span>
                        ${m.error ? `<span class="error">Â±${m.error.toFixed(3)}</span>` : ''}
                        ${formatCatalogId(m.catalogId)}
                        ${vizierLink(m.catalog, m.source)}
                    </div>
                `).join('');
            }
            
            // Add additional Vizier rotation periods from searchRotationPeriods (avoiding duplicates)
            if (vizierRot && vizierRot.length > 0) {
                const existingValues = new Set((vizierYouth.prot || []).map(m => m.value.toFixed(2)));
                vizierRot.forEach(r => {
                    if (!existingValues.has(r.period.toFixed(2))) {
                        rotHTML += `
                            <div class="youth-item">
                                <span class="value prot-color">${r.period.toFixed(3)} d</span>
                                ${r.error ? `<span class="error">Â±${r.error.toFixed(3)}</span>` : ''}
                                ${formatCatalogId(r.catalogId)}
                                ${vizierLink(r.catalog, r.source)}
                            </div>
                        `;
                    }
                });
            }
            
            if (rotHTML === '') {
                rotHTML = '<div class="no-data">No measurements found</div>';
            }
            rotContainer.innerHTML = rotHTML;

            // === log(R'HK) ===
            let rhkHTML = '';
            
            if (vizierYouth.rhk && vizierYouth.rhk.length > 0) {
                rhkHTML = vizierYouth.rhk.map(m => `
                    <div class="youth-item">
                        <span class="value rhk-color">${m.value.toFixed(3)}</span>
                        ${m.error ? `<span class="error">Â±${m.error.toFixed(3)}</span>` : ''}
                        ${formatCatalogId(m.catalogId)}
                        ${vizierLink(m.catalog, m.source)}
                    </div>
                `).join('');
            } else {
                rhkHTML = '<div class="no-data">No measurements found</div>';
            }
            rhkContainer.innerHTML = rhkHTML;
            
            // === X-ray Luminosity ===
            const lxContainer = document.getElementById('lx-results');
            let lxHTML = '';
            
            if (vizierYouth.lx && vizierYouth.lx.length > 0) {
                lxHTML = vizierYouth.lx.map(m => {
                    let valueStr;
                    if (m.isLog) {
                        valueStr = m.value.toFixed(2);
                    } else {
                        valueStr = m.value.toExponential(2);
                    }
                    return `
                        <div class="youth-item">
                            <span class="value lx-color">${valueStr}${m.isLog ? '' : ' erg/s'}</span>
                            ${m.error ? `<span class="error">Â±${m.error.toFixed(2)}</span>` : ''}
                            ${formatCatalogId(m.catalogId)}
                            ${vizierLink(m.catalog, m.source)}
                        </div>
                    `;
                }).join('');
            } else {
                lxHTML = '<div class="no-data">No measurements found</div>';
            }
            lxContainer.innerHTML = lxHTML;
        }

        // PARSEC isochrone data (BP-RP vs M_G)
        // These will be loaded from GitHub - placeholder data for now
        let parsecIsochrones = {
            myr100: null,
            gyr1: null
        };
        
        // Spectral type color bands for CMD background (on white)
        const spectralTypeColors = [
            { range: [-0.5, 0.0], color: 'rgba(155, 176, 255, 0.35)', label: 'O/B' },    // Blue
            { range: [0.0, 0.35], color: 'rgba(170, 191, 255, 0.30)', label: 'A' },      // Blue-white
            { range: [0.35, 0.6], color: 'rgba(248, 247, 220, 0.35)', label: 'F' },      // Pale yellow
            { range: [0.6, 0.85], color: 'rgba(255, 255, 180, 0.40)', label: 'G' },      // Yellow
            { range: [0.85, 1.4], color: 'rgba(255, 220, 180, 0.45)', label: 'K' },      // Orange
            { range: [1.4, 3.5], color: 'rgba(255, 180, 150, 0.40)', label: 'M' },       // Red
        ];

        // Load PARSEC isochrones from GitHub
        async function loadIsochrones() {
            const baseUrl = 'https://raw.githubusercontent.com/your-repo/isochrones/main/';
            
            // Try to load 100 Myr isochrone
            try {
                const resp100 = await fetch(baseUrl + 'parsec100MyrMH0.json');
                if (resp100.ok) {
                    parsecIsochrones.myr100 = await resp100.json();
                    console.log('Loaded 100 Myr isochrone');
                }
            } catch (e) {
                console.log('Could not load 100 Myr isochrone, using default');
            }
            
            // Try to load 1 Gyr isochrone
            try {
                const resp1g = await fetch(baseUrl + 'parsec1GyrMH0.json');
                if (resp1g.ok) {
                    parsecIsochrones.gyr1 = await resp1g.json();
                    console.log('Loaded 1 Gyr isochrone');
                }
            } catch (e) {
                console.log('Could not load 1 Gyr isochrone, using default');
            }
        }
        
        // Default simplified isochrone data (BP-RP, M_G) if files not available
        const defaultIsochrones = {
            myr100: [
                [-0.3, -2.5], [0.0, 0.5], [0.3, 2.0], [0.5, 3.0], [0.7, 4.0],
                [0.9, 5.0], [1.1, 5.8], [1.3, 6.5], [1.5, 7.2], [1.8, 8.0],
                [2.1, 9.0], [2.5, 10.5], [3.0, 12.5], [3.5, 14.5]
            ],
            gyr1: [
                [-0.3, -1.0], [0.0, 1.5], [0.3, 2.8], [0.5, 3.5], [0.7, 4.3],
                [0.9, 5.2], [1.1, 6.0], [1.3, 6.8], [1.5, 7.5], [1.8, 8.5],
                [2.1, 9.5], [2.5, 11.0], [3.0, 13.0], [3.5, 15.0]
            ]
        };

        function displayCMD(candidates, target) {
            const container = document.getElementById('cmd-plot');

            // Prepare candidate data
            const bprp = candidates.filter(c => c.bp_rp != null && c.abs_g != null).map(c => c.bp_rp);
            const absMag = candidates.filter(c => c.bp_rp != null && c.abs_g != null).map(c => c.abs_g);
            const voff = candidates.filter(c => c.bp_rp != null && c.abs_g != null).map(c => c.voff);
            const ids = candidates.filter(c => c.bp_rp != null && c.abs_g != null).map(c => c.source_id);
            const sep3d = candidates.filter(c => c.bp_rp != null && c.abs_g != null).map(c => c.sep_3d);

            // Target star with extinction correction if available
            let targetBpRp = target.bp_rp;
            let targetAbsMag = calculateAbsMag(target.phot_g_mean_mag, target.parallax);
            
            // Apply extinction correction if available (ag_gspphot and ebpminrp_gspphot)
            // Note: These may not always be available from VizieR Gaia DR3
            const hasExtinction = target.ag_gspphot != null && !isNaN(target.ag_gspphot);
            if (hasExtinction) {
                targetAbsMag = target.phot_g_mean_mag - target.ag_gspphot + 5 * Math.log10(target.parallax) - 10;
                if (target.ebpminrp_gspphot != null && !isNaN(target.ebpminrp_gspphot)) {
                    targetBpRp = target.bp_rp - target.ebpminrp_gspphot;
                }
            }

            const traces = [];
            const shapes = [];

            // Add spectral type color bands as background shapes
            spectralTypeColors.forEach(band => {
                shapes.push({
                    type: 'rect',
                    xref: 'x',
                    yref: 'paper',
                    x0: band.range[0],
                    x1: band.range[1],
                    y0: 0,
                    y1: 1,
                    fillcolor: band.color,
                    line: { width: 0 },
                    layer: 'below'
                });
            });
            
            // Instability strip boundaries
            shapes.push({
                type: 'line',
                x0: -0.1937, y0: 4.3871,
                x1: 0.6589, y1: -4.87,
                line: { color: 'rgba(59, 130, 246, 0.5)', width: 1.5, dash: 'dash' },
                layer: 'below'
            });
            shapes.push({
                type: 'line',
                x0: 0.3113, y0: 4.7419,
                x1: 1.6108, y1: -4.87,
                line: { color: 'rgba(239, 68, 68, 0.5)', width: 1.5, dash: 'dash' },
                layer: 'below'
            });

            // 100 Myr isochrone
            const iso100 = parsecIsochrones.myr100 || defaultIsochrones.myr100;
            traces.push({
                x: iso100.map(p => p[0]),
                y: iso100.map(p => p[1]),
                mode: 'lines',
                name: '100 Myr',
                line: { color: '#0891b2', width: 2.5 }
            });

            // 1 Gyr isochrone
            const iso1g = parsecIsochrones.gyr1 || defaultIsochrones.gyr1;
            traces.push({
                x: iso1g.map(p => p[0]),
                y: iso1g.map(p => p[1]),
                mode: 'lines',
                name: '1 Gyr',
                line: { color: '#475569', width: 2, dash: 'dot' }
            });

            // Sun marker - use text annotation for âŠ™ symbol
            traces.push({
                x: [0.82],
                y: [4.83],
                mode: 'text',
                name: 'Sun',
                text: ['âŠ™'],
                textposition: 'middle center',
                textfont: { size: 24, color: '#000', family: 'serif' },
                hoverinfo: 'name',
                showlegend: true
            });

            // Candidates colored by velocity offset
            if (bprp.length > 0) {
                traces.push({
                    x: bprp,
                    y: absMag,
                    mode: 'markers',
                    name: 'Comoving Candidates',
                    marker: {
                        size: sep3d.map(s => Math.max(6, 14 - s * 0.3)),
                        color: voff,
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: {
                            title: 'V<sub>off</sub>',
                            titleside: 'right',
                            len: 0.4,
                            thickness: 12,
                            x: 1.02,
                            y: 0.5
                        },
                        line: { color: '#fff', width: 1 }
                    },
                    text: ids.map((id, i) => `ID: ${id}<br>Bp-Rp: ${bprp[i]?.toFixed(3)}<br>M_G: ${absMag[i]?.toFixed(2)}<br>V_off: ${voff[i]?.toFixed(2)} km/s<br>Sep: ${sep3d[i]?.toFixed(1)} pc`),
                    hoverinfo: 'text'
                });
            }

            // Target star (white dot with black outline)
            if (targetBpRp != null && targetAbsMag != null && !isNaN(targetAbsMag)) {
                const targetMarker = {
                    x: [targetBpRp],
                    y: [targetAbsMag],
                    mode: 'markers',
                    name: hasExtinction ? 'Target (corrected)' : 'Target',
                    marker: {
                        size: 14,
                        color: '#ef4444',
                        symbol: target.ruwe > 1.25 ? 'square' : 'circle',
                        line: { color: '#000000', width: 2 }
                    },
                    text: [`Target<br>Bp-Rp: ${targetBpRp.toFixed(3)}<br>M_G: ${targetAbsMag.toFixed(2)}${hasExtinction ? ' (ext. corr.)' : ''}<br>RUWE: ${target.ruwe?.toFixed(2) || 'N/A'}`],
                    hoverinfo: 'text'
                };
                traces.push(targetMarker);
                
                // Add X marker if no extinction correction available
                if (!hasExtinction) {
                    traces.push({
                        x: [targetBpRp],
                        y: [targetAbsMag],
                        mode: 'markers',
                        name: 'No ext. correction',
                        marker: { size: 8, color: '#000', symbol: 'x' },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                }
            }

            const layout = {
                paper_bgcolor: '#ffffff',
                plot_bgcolor: '#ffffff',
                font: { color: '#1a1a2e', family: 'IBM Plex Sans', size: 12 },
                xaxis: {
                    title: { text: 'BP - RP (mag)', font: { size: 14, color: '#1a1a2e' } },
                    gridcolor: 'rgba(100, 100, 100, 0.3)',
                    zerolinecolor: '#666',
                    range: [-0.5, 3.5],
                    dtick: 0.5,
                    tickfont: { size: 12, color: '#1a1a2e' }
                },
                yaxis: {
                    title: { text: 'M<sub>G</sub> (mag)', font: { size: 14, color: '#1a1a2e' } },
                    gridcolor: 'rgba(100, 100, 100, 0.3)',
                    zerolinecolor: '#666',
                    range: [16, -4],
                    dtick: 2,
                    tickfont: { size: 12, color: '#1a1a2e' }
                },
                shapes: shapes,
                legend: {
                    x: 0.02,
                    y: 0.02,
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: '#ccc',
                    borderwidth: 1,
                    font: { size: 11, color: '#1a1a2e' }
                },
                margin: { t: 20, r: bprp.length > 0 ? 50 : 20, b: 50, l: 55 },
                hovermode: 'closest'
            };

            Plotly.newPlot(container, traces, layout, { responsive: true });
        }
        
        // Gyrochronology data - cluster rotation sequences
        // Format: { teff: [], prot: [] } for each cluster
        const gyroClusterData = {
            // 80 Myr - Î± Per (approximate from Boyle+2023)
            alphaPer: {
                age: 80, label: '80 Myr Î± Per', color: '#22d3ee',
                teff: [6500, 6200, 6000, 5800, 5500, 5200, 5000, 4500, 4000, 3500, 3200],
                prot: [0.5, 0.8, 1.0, 1.3, 1.8, 2.2, 2.5, 2.0, 1.5, 0.8, 0.5]
            },
            // 120 Myr - Pleiades (from Rebull+2016)
            pleiades: {
                age: 120, label: '120 Myr Pleiades', color: '#3b82f6',
                teff: [6500, 6200, 6000, 5800, 5500, 5200, 5000, 4500, 4000, 3500, 3200],
                prot: [1.0, 1.5, 2.0, 2.8, 3.5, 4.2, 5.0, 5.5, 4.0, 2.0, 1.0]
            },
            // 300 Myr - NGC 3532 (from Fritzewski+2021)
            ngc3532: {
                age: 300, label: '300 Myr NGC 3532', color: '#eab308',
                teff: [6500, 6200, 6000, 5800, 5500, 5200, 5000, 4500, 4000, 3500],
                prot: [2.0, 3.5, 5.0, 6.5, 7.5, 8.5, 9.5, 10.0, 8.0, 5.0]
            },
            // 670 Myr - Praesepe (from Douglas+2017)
            praesepe: {
                age: 670, label: '670 Myr Praesepe', color: '#22c55e',
                teff: [6500, 6200, 6000, 5800, 5500, 5200, 5000, 4500, 4000, 3500],
                prot: [4.0, 6.0, 8.0, 10.0, 11.5, 12.5, 13.0, 12.0, 9.0, 5.0]
            },
            // 1 Gyr - NGC 6811 (from Curtis+2019)
            ngc6811: {
                age: 1000, label: '1 Gyr NGC 6811', color: '#f97316',
                teff: [6500, 6200, 6000, 5800, 5500, 5200, 5000, 4500, 4000],
                prot: [5.0, 8.0, 10.5, 12.5, 14.0, 15.0, 15.5, 14.0, 11.0]
            }
        };
        
        // Spectral type to Teff mapping for secondary x-axis
        const sptTeffMapping = [
            { spt: 'F2', teff: 6900 },
            { spt: 'F5', teff: 6500 },
            { spt: 'G2', teff: 5800 },
            { spt: 'K0', teff: 5200 },
            { spt: 'K5', teff: 4400 },
            { spt: 'M0', teff: 3850 },
            { spt: 'M3', teff: 3400 }
        ];

        function displayGyroPlot(target, rotationPeriod) {
            const container = document.getElementById('gyro-plot');
            const panel = document.getElementById('gyro-panel');
            
            // Only show if we have both Teff and rotation period
            if (!target.teff_gspphot || !rotationPeriod) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            const targetTeff = target.teff_gspphot;
            const targetProt = rotationPeriod;
            
            const traces = [];
            
            // Add cluster sequences as lines
            Object.values(gyroClusterData).forEach(cluster => {
                traces.push({
                    x: cluster.teff,
                    y: cluster.prot,
                    mode: 'lines',
                    name: cluster.label,
                    line: { color: cluster.color, width: 2.5 },
                    hoverinfo: 'name'
                });
            });
            
            // Add target star
            traces.push({
                x: [targetTeff],
                y: [targetProt],
                mode: 'markers',
                name: target._resolvedName || 'Target',
                marker: {
                    size: 16,
                    color: '#ef4444',
                    symbol: 'star',
                    line: { color: '#000', width: 1.5 }
                },
                hovertemplate: `<b>${target._resolvedName || 'Target'}</b><br>Teff: %{x:.0f} K<br>Prot: %{y:.2f} d<extra></extra>`
            });
            
            // Spectral type annotations at top
            const annotations = sptTeffMapping.map(s => ({
                x: s.teff,
                y: 16,
                xref: 'x',
                yref: 'y',
                text: s.spt,
                showarrow: false,
                font: { size: 12, color: '#1a1a2e' }
            }));
            
            const layout = {
                paper_bgcolor: '#ffffff',
                plot_bgcolor: '#ffffff',
                font: { color: '#1a1a2e', family: 'IBM Plex Sans', size: 12 },
                xaxis: {
                    title: { text: 'Effective Temperature [K]', font: { size: 14, color: '#1a1a2e' } },
                    gridcolor: 'rgba(100, 100, 100, 0.3)',
                    zerolinecolor: '#666',
                    range: [7000, 3000],  // Reversed (hot to cool)
                    tickfont: { size: 12, color: '#1a1a2e' },
                    autorange: false
                },
                yaxis: {
                    title: { text: 'Rotation Period [days]', font: { size: 14, color: '#1a1a2e' } },
                    gridcolor: 'rgba(100, 100, 100, 0.3)',
                    zerolinecolor: '#666',
                    range: [0, 16],
                    tickfont: { size: 12, color: '#1a1a2e' }
                },
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: '#ccc',
                    borderwidth: 1,
                    font: { size: 10, color: '#1a1a2e' }
                },
                annotations: annotations,
                margin: { t: 30, r: 20, b: 50, l: 60 },
                hovermode: 'closest'
            };

            Plotly.newPlot(container, traces, layout, { responsive: true });
        }
        
        function downloadGyroPlot() {
            Plotly.downloadImage('gyro-plot', {
                format: 'png',
                width: 800,
                height: 500,
                filename: `GaiaDR3_${targetData.source_id}_gyro`
            });
        }

        function displayTable(candidates) {
            const tbody = document.getElementById('results-tbody');
            const countBadge = document.getElementById('candidate-count');
            
            countBadge.textContent = `${candidates.length} stars`;

            tbody.innerHTML = candidates.map((c, i) => {
                const isTarget = c.sep_3d < 0.001;
                const rotPeriod = rotationPeriods[c.source_id];
                const protStr = rotPeriod && rotPeriod.length > 0 ? rotPeriod[0].period.toFixed(3) : '';
                
                return `
                    <tr class="${isTarget ? 'target-row' : ''}">
                        <td>${c.index}</td>
                        <td>${c.source_id}</td>
                        <td>${c.ra?.toFixed(5) || ''}</td>
                        <td>${c.dec?.toFixed(5) || ''}</td>
                        <td>${c.phot_g_mean_mag?.toFixed(3) || ''}</td>
                        <td>${c.bp_rp?.toFixed(3) || ''}</td>
                        <td>${c.voff?.toFixed(2) || ''}</td>
                        <td>${c.sep_deg?.toFixed(4) || ''}</td>
                        <td>${c.sep_3d?.toFixed(3) || ''}</td>
                        <td>${targetData.radial_velocity?.toFixed(1) || ''}</td>
                        <td>${c.radial_velocity?.toFixed(1) || ''}</td>
                        <td>${c.spt}</td>
                        <td>${c.ruwe?.toFixed(2) || ''}</td>
                        <td>${protStr}</td>
                    </tr>
                `;
            }).join('');
        }

        function downloadCSV() {
            if (searchResults.length === 0) return;

            const headers = ['Index', 'Gaia_DR3_source_id', 'RA', 'Dec', 'Parallax_mas', 'Distance_pc', 'Gmag', 'Bp-Rp', 'Voff_km_s', 
                'Sep_deg', 'Sep3D_pc', 'RV_obs', 'SpT', 'RUWE', 'Prot_d', 'Prot_err_d', 'Prot_src'];

            const rows = searchResults.map(c => {
                const rot = rotationPeriods[c.source_id];
                const prot = rot && rot.length > 0 ? rot[0] : null;
                const distPc = c.parallax > 0 ? 1000 / c.parallax : null;
                
                return [
                    c.index,
                    c.source_id,
                    c.ra?.toFixed(7) || '',
                    c.dec?.toFixed(7) || '',
                    c.parallax?.toFixed(4) || '',
                    distPc?.toFixed(2) || '',
                    c.phot_g_mean_mag?.toFixed(3) || '',
                    c.bp_rp?.toFixed(3) || '',
                    c.voff?.toFixed(3) || '',
                    c.sep_deg?.toFixed(5) || '',
                    c.sep_3d?.toFixed(4) || '',
                    c.radial_velocity?.toFixed(2) || '',
                    c.spt || '',
                    c.ruwe?.toFixed(3) || '',
                    prot ? prot.period.toFixed(4) : '',
                    prot && prot.error ? prot.error.toFixed(4) : '',
                    prot ? prot.source : ''
                ].join(',');
            });

            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `GaiaDR3_${targetData.source_id}_comoving.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadPlot() {
            Plotly.downloadImage('cmd-plot', {
                format: 'png',
                width: 600,
                height: 900,
                filename: `GaiaDR3_${targetData.source_id}_CMD`
            });
        }

        // Allow Enter key to trigger search
        document.getElementById('target-id').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') runSearch();
        });
    </script>
</body>
</html>
